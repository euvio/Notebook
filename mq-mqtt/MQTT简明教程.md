服务器： Broker

客户端 ：发布者 订阅者

消息体：Topic Payload







客户端A订阅主题t1后，客户端B无需订阅主题t1，也可以publish主题t1，此时客户端A会收到，客户端B不会收到，

如果客户端B也订阅主题t1，那么客户端A和B均会收到主题t1.



如何注册主题？

使用任一客户端订阅即可，服务器会留有主题存根。

无存根，相当于注册 + 订阅！有存根，相当于仅仅是订阅。



# 连接客户端

客户端与服务端连接成功后，第一个报文必须是CONNECT报文，在一个网络连接上，客户端只能发送一次CONNECT报文。

## ClientID

必需。

客户端ID必须是唯一的。

客户端ID用于维护客户端与服务端的会话状态。

客户端ID一般随机生成。如果连接时需要重新恢复会话状态，即不清理会话，则客户端ID显然不能随机生成。

## UserName

可选

## Password

可选

## Protocol Level

必需

MQTT协议版本号

## Clean Session

必需

TRUE，清理会话状态。客户端和服务端断开连接后，会话状态会被清除。客户端再次重连服务端，需要重新订阅话题。

FALSE，不清理会话状态。客户端和服务端断开连接后，会话状态会被保留。客户端再次重连服务端，会恢复到未断开前的状态。因此，要确保不丢失连接断开期间的消息，需要使用QoS 1或 QoS 2级别，同时将清理会话标志设置为FALSE。当客户端决定之后不再使用这个会话时，应该将清理会话标志设置为1最后再连接一次，然后断开连接。

## WILL

遗嘱（Will Message）消息**必须**被存储在服务端并且与这个网络连接关联。之后网络连接关闭时，服务端**必须**发布这个遗嘱消息，除非服务端收到DISCONNECT报文时删除了这个遗嘱消息.

遗嘱消息发布的条件，包括但不限于：

- 服务端检测到了一个I/O错误或者网络故障。
- 客户端在保持连接（Keep Alive）的时间内未能通讯。
- 客户端没有先发送DISCONNECT报文直接关闭了网络连接。
- 由于协议错误服务端关闭了网络连接。

Will QoS和Will Retain

Will Topic和Will Message

一旦被发布或者服务端收到了客户端发送的DISCONNECT报文，遗嘱消息就**必须**从存储的会话状态中移除

## Keep Alive

保持连接（Keep Alive）是一个以秒为单位的时间间隔，表示为一个16位的字，它是指在客户端传输完成一个控制报文的时刻到发送下一个报文的时刻，两者之间允许空闲的最大时间间隔。客户端负责保证控制报文发送的时间间隔不超过保持连接的值。如果没有任何其它的控制报文可以发送，客户端**必须**发送一个PINGREQ报文 [MQTT-3.1.2-23]。

不管保持连接的值是多少，客户端任何时候都可以发送PINGREQ报文，并且使用PINGRESP报文判断网络和服务端的活动状态。

如果保持连接的值非零，并且服务端在一点五倍的保持连接时间内没有收到客户端的控制报文，它**必须**断开客户端的网络连接，认为网络连接已断开 [MQTT-3.1.2-24]。

客户端发送了PINGREQ报文之后，如果在合理的时间内仍没有收到PINGRESP报文，它**应该**关闭到服务端的网络连接。

保持连接的值为零表示关闭保持连接功能。这意味着，服务端不需要因为客户端不活跃而断开连接。注意：不管保持连接的值是多少，任何时候，只要服务端认为客户端是不活跃或无响应的，可以断开客户端的连接。

> **非规范评注**
>
> 保持连接的实际值是由应用指定的，一般是几分钟。允许的最大值是18小时12分15秒。

# 发布消息

## TopicName

不能含有通配符





# 服务质量QoS

QoS = 0 至多一次，客户端发送出去消息后，不管死活，失败了也不会重试

QoS = 1 至少一次，客户端发送出去消息后，会检查消息是否成功，失败了会重试，容忍不严谨的重试机制导致的同一条消息到达客户端多次

QoS = 2 有且仅有一次，严格的保证消息会送到目的地且只送到一次

不同的QoS质量，对MQTT性能影响十分显著，QoS = 1的性能约是QoS = 2的100倍。性能测试链接：[发布MQTT消息究竟有多快？ - jlroy - 博客园 (cnblogs.com)](https://www.cnblogs.com/jlroy/p/4748110.html)

# MQTT主题与主题过滤器

## 主题

定阅与发布必须要有主题，只有当定阅了某个主题后，才能收到相应主题的payload。一个主题名可以由多个主题层级组成，每一层通过`/`斜杠分隔开，例如`myhome/livingroom/temperature`。

下面的字符串都是合法的主题：

- `mytopic`

- `top_level_topic/second_level_topic`

- `\`

## 主题过滤器

含有通配符的主题，称为主题过滤器，也是主题，目的是让客户端使用一个字符串就可以同时订阅多个主题。当客户端订阅主题时，可以使用确切主题，如`myhome/livingroom/temperature`，也可以使用主题过滤器，如`myhome/+/temperature`。但是客户端发布消息时，主题必须使用确切主题，不得使用主题过滤器。

### 多层通配符#

多层通配符`#`表示它的父级和任意数量的子层级。多层通配符`#`必须位于层级分隔符`/`后面，且必须是主题过滤器的最后一个字符 。

如果客户端订阅主题 “china/guangzhou/#”，它会收到使用下列主题名发布的消息：

`china/guangzhou`

`china/guangzhou/huangpu`

`china /guangzhou/tianhe/zhongshanlu`

`china/guangzhou/tianhe/zhongshanlu/num123`

其他示例：

`school/#`   合法的主题过滤器，也能匹配主题`school`，因为#能匹配它的父级

`#`，合法的主题过滤器，能收到所有形式主题的消息

`school/teacher#`，非法的主题过滤器，因为#必须位于主题分隔符后面

`school/teacher/#/math`，非法的主题过滤器，因为#必须是主题过滤器的最后一个字符

### 单层通配符+

`china/+`+ 只能匹配 `china/guangzhou`

`china/+/+/zhongshanlu` 能匹配`china/guangzhou/tianhe/zhongshanlu`和`china/shenzhen/nanshan/zhongshanlu`

`+`是合法的主题过滤器

### 系统保留主题$

在‘#’或‘/’进行匹配时，以‘$’开头的主题将不会被匹配到。 换言之，服务器将禁止客户端使用此类话题与其他客户端通信，以‘$’开头的话题作为系统保留主题，供内部使用，这些主题的消息不会被客户端所发布或订阅。在MQTT中，“$SYS/”被广泛用作包含特定于服务器的信息或控件API的主题的前缀。在下列例子中，展示了‘$’和两种通配符共存时的一些情况：

`#`匹配不到以`$`开头的主题
`+/monitor/clients`将匹配不到`$SYS/monitor/clients`
`$SYS/monitor/+`可以匹配到“`$SYS/monitor/clients`

### 实现广播

所有的客户端都订阅某一个主题即可，此主题一般命名为`boardcast`，然后任一客户端发送主题是`boardcast`即可。

### 总结

1. 建议主题和主题过滤器的各个层级字符串，要么仅是`#`或`+`,要么是仅由字母数字下划线组成的字符串，主题最后一个字符不要是`/`
2. 啊哟么使用题过滤器必须至少包含一个字符
3. 主题名或主题过滤器以前置或后置斜杠 “/” 区分
4. 只包含斜杠 “/” 的主题名或主题过滤器是合法的
5. 主题名和主题过滤器是 UTF-8 编码字符串， 它们不能超过 65535 字节
6. 主题名和主题过滤器是区分大小写的

# MQTT应用模型

# 任意两台主机可以相互通信

网络中的每台主机使用Topic作为身份标识并向服务器注册此Topic，只需要向Topic Publish消息就可到达主机。





